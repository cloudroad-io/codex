# codex

Расширенное руководство по тестированию и запуску автоматических проверок для проекта.

## Содержание
- [Обзор](#обзор)
- [Требования](#требования)
- [Структура тестов](#структура-тестов)
- [Настройка окружения](#настройка-окружения)
  - [Через venv/pip](#через-venvpip)
  - [Через Poetry](#через-poetry)
  - [Через Docker](#через-docker)
- [Запуск тестов](#запуск-тестов)
  - [Unit-тесты](#unit-тесты)
  - [Интеграционные тесты](#интеграционные-тесты)
  - [Статический анализ и линтеры](#статический-анализ-и-линтеры)
  - [Покрытие кода](#покрытие-кода)
- [Работа с тестовыми данными](#работа-с-тестовыми-данными)
- [Отладка и локальный цикл разработки](#отладка-и-локальный-цикл-разработки)
- [CI/CD](#cicd)
- [Добавление новых тестов](#добавление-новых-тестов)
- [Полезные команды](#полезные-команды)
- [Часто задаваемые вопросы](#часто-задаваемые-вопросы)

## Обзор
Тестовый контур проекта включает несколько уровней проверок: быстрые unit-тесты, более тяжёлые интеграционные проверки и статический анализ. Данное руководство описывает, как подготовить окружение, запускать тесты локально и разбирать результаты.

## Требования
- Git ≥ 2.30
- Python 3.10+ (или другой язык/версия, принятие в проекте)
- Make, Docker и Docker Compose — опционально, если вы предпочитаете контейнеризированный запуск
- Доступ к частным пакетам/артефактам (при необходимости)

## Структура тестов
Рекомендуемая структура каталогов:
```
project_root/
├── src/               # исходный код
├── tests/
│   ├── unit/          # модульные тесты
│   ├── integration/   # интеграционные тесты
│   └── fixtures/      # общие фикстуры и тестовые данные
└── tools/             # скрипты утилиты (линтеры, генераторы данных)
```
Фактическая структура может отличаться; придерживайтесь общих принципов: unit-тесты должны быть быстрыми и изолированными, интеграционные проверки — работать с внешними зависимостями через фикстуры/контейнеры.

## Настройка окружения

### Через venv/pip
```bash
python -m venv .venv
source .venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt       # основные зависимости
pip install -r requirements-test.txt  # тестовые и dev-зависимости
```

### Через Poetry
```bash
poetry install --with test,dev
poetry shell
```

### Через Docker
```bash
docker compose build test
docker compose run --rm test
```
Docker-окружение удобно для интеграционных проверок, требующих внешних сервисов (БД, очереди и т. п.).

## Запуск тестов

### Unit-тесты
```bash
pytest tests/unit -n auto --maxfail=1
```
Ключ `-n auto` (требует `pytest-xdist`) включает параллельный запуск, что ускоряет обратную связь.

### Интеграционные тесты
```bash
pytest tests/integration -m "not slow" --docker-compose=tests/docker-compose.yml
```
- Используйте маркеры `slow`, `requires_db` и т. д., чтобы управлять набором тестов.
- Для тяжёлых сценариев добавьте флаг `--runslow`.

### Статический анализ и линтеры
```bash
ruff check src tests
mypy src
```
При необходимости замените инструменты на те, что используются в проекте (flake8, eslint, golangci-lint и др.).

### Покрытие кода
```bash
pytest --cov=src --cov-report=term-missing --cov-report=xml
```
XML-отчёт пригодится для интеграции с CI и отчётностью по PR.

## Работа с тестовыми данными
- Храните большие файлы за пределами репозитория (например, в `tests/fixtures/` c Git LFS или в артефакт-хранилище).
- Создавайте фабрики данных (Factory Boy, Faker) для генерации объектов на лету.
- Документируйте формат тестовых данных и используйте версионирование.

## Отладка и локальный цикл разработки
1. Запускайте быстрый набор `pytest tests/unit -q` перед коммитом.
2. Используйте `pytest --lf --maxfail=1` для повторного запуска только упавших тестов.
3. Включайте `-vv` и `--pdb` при необходимости интерактивной отладки.
4. Для сложных интеграций применяйте docker-compose и логи сервисов.

## CI/CD
- Настройте GitHub Actions/GitLab CI для автоматического прогона unit-тестов и линтеров на каждый PR.
- Интеграционные и e2e-тесты запускайте по расписанию или на ветках релизов.
- Используйте кэширование зависимостей и артефактов покрытия для ускорения.

## Добавление новых тестов
- Следуйте соглашениям об именовании файлов (`test_*.py`).
- Оборачивайте тестируемую функциональность фикстурами, чтобы минимизировать дублирование кода.
- Обновляйте документацию и примеры использования при добавлении новых сценариев.

## Полезные команды
```bash
make test           # агрегирует unit + lint (при наличии Makefile)
make test-unit      # только unit-тесты
make lint           # статический анализ
make coverage-html  # генерация html-отчёта покрытия
```

## Часто задаваемые вопросы
**Как запускать только один тест?**
```bash
pytest tests/unit/test_example.py::test_specific_case
```

**Как пересоздать окружение с нуля?**
```bash
rm -rf .venv
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt -r requirements-test.txt
```

**Что делать, если тест падает только в CI?**
- Проверьте версии зависимостей (в CI они могут отличаться).
- Убедитесь, что все секреты и переменные окружения заданы.
- Сравните логи CI и локального запуска, чтобы выявить различия в конфигурации.

